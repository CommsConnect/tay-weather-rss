name: Update Tay weather RSS

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:
    inputs:
      test_x:
        description: "Post a TEST update to X (bypasses alert feed + cooldown/dedupe)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      test_facebook:
        description: "Post a TEST update to Facebook (bypasses alert feed + cooldown/dedupe)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

concurrency:
  group: tay-weather-rss
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    env:
      # --- Feature toggles ---
      ENABLE_X_POSTING: true
      ENABLE_FB_POSTING: true

      # --- Test flags (per platform) ---
      TEST_X: ${{ github.event.inputs.test_x || 'false' }}
      TEST_FACEBOOK: ${{ github.event.inputs.test_facebook || 'false' }}

      # Optional backward compatibility (safe to remove later)
      TEST_TWEET: ${{ github.event.inputs.test_x || 'false' }}

      # --- Feeds & images ---
      ALERT_FEED_URL: https://weather.gc.ca/rss/battleboard/onrm94_e.xml
      TAY_COORDS_URL: https://weather.gc.ca/en/location/index.html?coords=44.751,-79.768
      TAY_ALERTS_URL: https://weatherpresenter.github.io/tay-weather-rss/tay/
      CR29_NORTH_IMAGE_URL: https://511on.ca/map/Cctv/400
      CR29_SOUTH_IMAGE_URL: https://511on.ca/map/Cctv/402

      # --- Content config ---
      CONTENT_CONFIG_SOURCE: auto
      CONTENT_CONFIG_XLSX: content_config.xlsx

      # --- Facebook safety ---
      FB_COOLDOWN_SECONDS: 3600      # 1 hour between successful FB posts
      FB_BLOCK_SECONDS: 21600        # 6 hours if rate-limited
      FB_JITTER_SECONDS: 10          # small randomness to avoid burst detection

    steps:
      - name: Check out repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sanity check config (non-secret)
        run: |
          echo "ENABLE_X_POSTING=$ENABLE_X_POSTING"
          echo "ENABLE_FB_POSTING=$ENABLE_FB_POSTING"
          echo "TEST_X=$TEST_X"
          echo "TEST_FACEBOOK=$TEST_FACEBOOK"
          echo "TAY_ALERTS_URL=$TAY_ALERTS_URL"
          echo "CONTENT_CONFIG_SOURCE=$CONTENT_CONFIG_SOURCE"
          echo "CONTENT_CONFIG_XLSX=$CONTENT_CONFIG_XLSX"
          if [ -n "$GOOGLE_SHEET_ID" ]; then echo "GOOGLE_SHEET_ID=set"; else echo "GOOGLE_SHEET_ID=missing"; fi
          if [ -n "$GOOGLE_SERVICE_ACCOUNT_JSON" ]; then echo "GOOGLE_SERVICE_ACCOUNT_JSON=set"; else echo "GOOGLE_SERVICE_ACCOUNT_JSON=missing"; fi
          if [ -n "$GOOGLE_DRIVE_FOLDER_ID" ]; then echo "GOOGLE_DRIVE_FOLDER_ID=set"; else echo "GOOGLE_DRIVE_FOLDER_ID=missing"; fi

      - name: Verify required secrets
        env:
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          X_REFRESH_TOKEN: ${{ secrets.X_REFRESH_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          missing=0

          for k in X_CLIENT_ID X_CLIENT_SECRET X_REFRESH_TOKEN; do
            if [ -z "${!k}" ]; then echo "Missing secret: $k"; missing=1; fi
          done

          for k in X_API_KEY X_API_SECRET X_ACCESS_TOKEN X_ACCESS_TOKEN_SECRET; do
            if [ -z "${!k}" ]; then echo "Missing secret: $k"; missing=1; fi
          done

          for k in FB_PAGE_ID FB_PAGE_ACCESS_TOKEN; do
            if [ -z "${!k}" ]; then echo "Missing secret: $k"; missing=1; fi
          done

          if [ "$missing" -ne 0 ]; then
            echo "One or more required secrets are missing."
            exit 1
          fi

            # ------------------------------------------------------------
      # Run the weather bot
      # - Fetches Environment Canada alerts
      # - Builds images and messages
      # - Posts to X / Facebook (or test mode)
      # - Writes x_refresh_token_rotated.txt if X refresh token rotated
      # ------------------------------------------------------------
      - name: Run weather bot
        env:
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_CLIENT_SECRET: ${{ secrets.X_CLIENT_SECRET }}
          X_REFRESH_TOKEN: ${{ secrets.X_REFRESH_TOKEN }}
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_ACCESS_TOKEN: ${{ secrets.FB_PAGE_ACCESS_TOKEN }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python tay_weather_bot.py

      # ------------------------------------------------------------
      # Detect whether the X refresh token was rotated
      # - Checks for x_refresh_token_rotated.txt created by the bot
      # - Sets a step output so later steps can branch cleanly
      # ------------------------------------------------------------
      - name: Detect X refresh token rotation
        id: xrot
        run: |
          if [ -f "x_refresh_token_rotated.txt" ]; then
            echo "rotated=true" >> $GITHUB_OUTPUT
          else
            echo "rotated=false" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------
      # Update the X_REFRESH_TOKEN repository secret (if rotated)
      # - Uses a PAT via GH_TOKEN (not GITHUB_TOKEN)
      # - Writes the new refresh token into Actions secrets
      # - Removes the temporary token file after success
      # ------------------------------------------------------------
      - name: Update rotated X refresh token
        if: steps.xrot.outputs.rotated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "Updating X_REFRESH_TOKEN secret..."
          gh secret set X_REFRESH_TOKEN \
            --body "$(cat x_refresh_token_rotated.txt)" \
            --repo "$GITHUB_REPOSITORY"
          echo "âœ“ Updated X_REFRESH_TOKEN secret"
          rm -f x_refresh_token_rotated.txt

      # ------------------------------------------------------------
      # Log when no X refresh token rotation occurred
      # - Runs only if the bot did not rotate the token
      # ------------------------------------------------------------
      - name: No X refresh token rotation
        if: steps.xrot.outputs.rotated == 'false'
        run: |
          echo "No rotated X refresh token."

      # ------------------------------------------------------------
      # Commit generated RSS feed and state file (if changed)
      # - Commits tay-weather.xml and state.json
      # - Pushes only when there are actual changes
      # ------------------------------------------------------------
      - name: Commit RSS + state updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tay-weather.xml state.json || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update RSS feed"
            git push
          fi
